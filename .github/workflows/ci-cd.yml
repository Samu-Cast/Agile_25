#Workflow completo per CI/CD: test, lint e build
name: CI/CD Pipeline

#Quando eseguire questo workflow
on:
  push:
    branches: [ main, preRelease, sam-branch ]
  pull_request:
    branches: [ main, preRelease, sam-branch ]

#Lavori da eseguire
jobs:
  #Lavoro per il backend
  backend:
    runs-on: ubuntu-latest
    
    steps:
      #Scarica il codice
      - uses: actions/checkout@v3
      
      #Installa Node.js
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: social-backend/package-lock.json
      
      #Installa dipendenze
      - name: Installa dipendenze
        run: npm ci
        working-directory: ./social-backend
      
      #Esegui test
      - name: Test
        run: npm test
        working-directory: ./social-backend
        env:
          NODE_ENV: test

  #Lavoro per il frontend
  frontend:
    runs-on: ubuntu-latest
    
    steps:
      #Scarica il codice
      - uses: actions/checkout@v3
      
      #Installa Node.js
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: social-frontend/package-lock.json
      
      #Installa dipendenze
      - name: Installa dipendenze
        run: npm ci
        working-directory: ./social-frontend
      
      #Esegui test con copertura
      - name: Test con copertura
        run: npm test -- --watchAll=false --coverage
        working-directory: ./social-frontend
        env:
          CI: true
          REACT_APP_API_URL: http://localhost:3001/api
      
      #Verifica che il build funzioni
      - name: Build
        run: npm run build
        working-directory: ./social-frontend
        env:
          CI: true
          REACT_APP_API_URL: http://localhost:3001/api
      
      #Salva il report di copertura come artifact
      - name: Salva report copertura
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: coverage-report
          path: social-frontend/coverage
          retention-days: 30
